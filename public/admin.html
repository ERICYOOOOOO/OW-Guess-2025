<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è£åˆ¤æ§åˆ¶å° - OWCS Admin</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { background-color: #333; color: #333; }
        
        .admin-container { 
            max-width: 1000px; 
            margin: 2rem auto; 
            padding: 25px; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 { text-align: center; color: var(--accent-purple); margin-bottom: 30px; }

        .section-box { 
            border: 2px solid #eee; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 25px; 
            background: #fff;
        }
        
        .section-title { 
            margin-top: 0; 
            color: var(--accent-purple); 
            border-bottom: 2px solid var(--primary-pink); 
            padding-bottom: 10px; 
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- æ¯”èµ›åˆ—è¡¨æ ·å¼ --- */
        .match-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            border-bottom: 1px solid #eee; 
            transition: background 0.2s;
        }
        .match-row:hover { background: #f9f9f9; }
        
        .match-info { width: 45%; }
        .match-id { font-size: 0.85em; color: #888; margin-right: 10px; font-family: monospace; }
        
        /* TBD é”å®šæ ·å¼ */
        .match-row.tbd { 
            background-color: #f5f5f5; 
            color: #999; 
            opacity: 0.7; 
        }
        .match-row.tbd b { color: #999; }
        
        .status-finished { color: green; font-weight: bold; background: #e8f5e9; padding: 2px 8px; border-radius: 4px; }
        
        /* --- ç”¨æˆ·ç®¡ç†æ ·å¼ --- */
        .user-row { 
            background: #fdfdfd; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-left: 5px solid var(--accent-purple); 
            border-radius: 4px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .user-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
            padding-bottom: 10px;
            border-bottom: 1px dashed #eee;
        }

        .user-stats { font-size: 0.9rem; color: #555; }
        
        .user-achievements { 
            display: flex; 
            flex-wrap: wrap; 
            align-items: center; 
            gap: 10px; 
        }

        .ach-tag { 
            display: inline-flex; 
            align-items: center;
            background: #e0d4fc; 
            color: var(--accent-purple); 
            padding: 4px 10px; 
            border-radius: 15px; 
            font-size: 0.85rem; 
            font-weight: bold;
        }
        
        .ach-remove { 
            cursor: pointer; 
            color: #ff4d4d; 
            margin-left: 6px; 
            font-weight: bold; 
            font-size: 1.1em;
            line-height: 1;
        }
        .ach-remove:hover { color: red; transform: scale(1.2); }

        /* --- å¼¹çª—æ ·å¼ --- */
        #manual-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999; backdrop-filter: blur(2px); }
        #manual-form { 
            display:none; 
            position: fixed; 
            top:50%; left:50%; 
            transform:translate(-50%, -50%); 
            background:white; 
            padding:25px; 
            border-radius:15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            z-index: 1000; 
            width: 320px; 
            border: 2px solid var(--primary-pink);
        }
        
        #manual-form h4 { margin-top: 0; color: var(--accent-purple); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #manual-form label { display: block; margin-top: 10px; font-size: 0.85rem; font-weight: bold; color: #666; }
        #manual-form input, #manual-form select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; }
        
        .form-actions { display:flex; gap:10px; margin-top:20px; }

        input[type="number"] { width: 40px; text-align: center; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="admin-container">
        <h1>ğŸ‘® OWCS èµ›äº‹æ€»æ§å°</h1>

        <div class="section-box">
            <h3 class="section-title">ğŸ‘¥ ç©å®¶ç®¡ç† (Achievements & Scores)</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="user-search" placeholder="è¾“å…¥æ˜µç§°æœç´¢ç©å®¶..." style="flex:1; padding:10px; border:1px solid #ccc; border-radius:5px;">
                <button onclick="searchUsers()" class="btn-primary">ğŸ” æœç´¢</button>
            </div>
            <div id="user-results"></div>
        </div>

        <div class="section-box">
            <h3 class="section-title">ğŸ® æ¯”èµ›ç®¡ç† (Matches)</h3>
            <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">
                * TBD = é˜Ÿä¼å¾…å®š (è‡ªåŠ¨é”å®š)ã€‚<br>
                * ç‚¹å‡» ğŸ”’/ğŸ”“ æŒ‰é’®å¯æ‰‹åŠ¨æš‚åœæŸåœºæ¯”èµ›çš„é¢„æµ‹ã€‚<br>
                * å½•å…¥ç»“æœåå°†è‡ªåŠ¨æ™‹çº§èƒœè€…ã€‚
            </p>
            <div id="admin-matches">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <div class="section-box" style="border-color:red; background:#fff5f5; margin-top:40px;">
            <h3 class="section-title" style="color:red; border-bottom-color:red;">â˜¢ï¸ å±é™©åŒºåŸŸ (Danger Zone)</h3>
            <p style="color:#c00; font-size:0.9rem;">
                <b>å·¥å‚é‡ç½® (Factory Reset):</b><br>
                è¿™å°†åˆ é™¤æ‰€æœ‰ç©å®¶è´¦å·ã€é¢„æµ‹è®°å½•ã€æ—¥å¿—ï¼Œå¹¶å°†èµ›ç¨‹é‡ç½®ä¸ºåˆå§‹çŠ¶æ€ã€‚<br>
                æ­¤æ“ä½œä¸å¯é€†ï¼
            </p>
            <button onclick="factoryReset()" style="background:red; color:white; border:none; padding:10px 20px; font-weight:bold; cursor:pointer; border-radius:5px; width:100%;">
                ğŸ’£ åˆ é™¤æ‰€æœ‰æ•°æ®å¹¶é‡ç½®ç³»ç»Ÿ
            </button>
        </div>
    </div>

    <div id="manual-overlay" onclick="closeManual()"></div>
    <div id="manual-form">
        <h4>âš¡ ä¿®æ­£ç©å®¶åˆ†æ•°</h4>
        <p style="margin:0 0 10px 0; font-size:0.9rem;">ç©å®¶: <b id="target-user-name" style="color:var(--primary-pink)"></b></p>
        <input type="hidden" id="target-user-id">
        
        <label>ğŸ¯ åº”ç”¨èŒƒå›´ (Target):</label>
        <select id="manual-target-day">
            <option value="0">ä»…ä¿®æ­£æ€»åˆ† (Total Only)</option>
            <option value="1">Day 1 (11.26)</option>
            <option value="2">Day 2 (11.27)</option>
            <option value="3">Day 3 (11.28)</option>
            <option value="4">Day 4 (11.29)</option>
            <option value="5">Day 5 (11.30)</option>
        </select>
        <small style="color:#888; font-size:0.75rem;">* é€‰æ‹© Day X ä¼šåŒæ—¶æ›´æ–°æ€»æ¦œå’Œå½“å¤©çš„æ—¥æ¦œ</small>

        <label>ğŸ”¢ åˆ†æ•°å˜åŠ¨ (Points):</label>
        <input type="number" id="manual-points" placeholder="ä¾‹å¦‚: 10 æˆ– -5" style="width:100%; text-align:left;">
        
        <label>ğŸ“ ä¿®æ­£ç†ç”± (Reason):</label>
        <input type="text" id="manual-reason" placeholder="ä¾‹å¦‚: ç®¡ç†å‘˜è¡¥åˆ†">
        
        <div class="form-actions">
            <button onclick="submitManualScore()" class="btn-primary" style="flex:1">æäº¤ä¿®æ­£</button>
            <button onclick="closeManual()" style="flex:1; background:#eee; border:none; color:#333; cursor:pointer; border-radius:4px;">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        const API = '/api/admin';
        const headers = { 'Content-Type': 'application/json', 'adminSecret': '123456' };
        
        const ALL_ACHIEVEMENTS = [
            "é—ªç”µå¿µ", "è€å¼€çˆ±ç‚¸å¢™", "reverse sweep", "åƒåœŸè±†", "å†å†²ä¸€æ¬¡", 
            "æœ€ä¸­å¹»æƒ³", "landonè§é¢äº¤é“ƒé“›tp", "å†¯å“¥è§é¢ä¸‰æ®µé—ª", "é—¹éº»äº†", 
            "ä»¥çˆ¶ä¹‹å", "æ–°çš‡åè¡—", "åå‘æœ¨å­", "P>L", "è¥¿å·´å ¡", "å–œå¿§å‚åŠ", "æ¥æ™šäº†"
        ];

        document.addEventListener('DOMContentLoaded', loadMatches);

        // ============================
        // 1. æ¯”èµ›ç®¡ç†é€»è¾‘
        // ============================
        async function loadMatches() {
            const res = await fetch('/api/matches');
            const matches = await res.json();
            const container = document.getElementById('admin-matches');
            container.innerHTML = '';

            matches.forEach(m => {
                const isFin = m.status === 'finished';
                const isLocked = m.isExplicitlyLocked; // è·å–æ‰‹åŠ¨é”å®šçŠ¶æ€
                
                const tbdA = m.teamA.name === 'TBD';
                const tbdB = m.teamB.name === 'TBD';
                const isTBD = tbdA || tbdB;
                
                const teamA = tbdA ? m.teamA.displayName : m.teamA.name;
                const teamB = tbdB ? m.teamB.displayName : m.teamB.name;

                // æ ¼å¼åŒ–æ—¶é—´ä»¥ä¾¿æ˜¾ç¤ºåœ¨ input type="datetime-local" ä¸­
                const d = new Date(m.startTime);
                // å¤„ç†æ—¶åŒºåç§»ï¼Œè½¬ä¸ºæœ¬åœ° ISO å­—ç¬¦ä¸²å‰ 16 ä½
                const localIso = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);

                const rowClass = isTBD ? 'match-row tbd' : 'match-row';
                
                let controlHtml = '';
                
                if (isTBD) {
                    controlHtml = `<span style="font-size:0.8rem; color:#aaa;">ğŸ”’ ç­‰å¾…æ™‹çº§</span>`;
                } else if (isFin) {
                    controlHtml = `
                        <span class="status-finished">âœ… ${m.teamA.score} : ${m.teamB.score}</span>
                        <button onclick="resetMatch('${m._id}')" style="margin-left:10px; border:none; background:none; cursor:pointer; font-size:0.8rem;" title="æ’¤é”€å¹¶å›æ»šåˆ†æ•°">
                            âŒ æ’¤é”€
                        </button>
                    `;
                } else {
                    controlHtml = `
                        <input type="number" id="sA_${m._id}" value="${m.teamA.score}" min="0" max="4"> 
                        <span style="margin:0 5px">:</span> 
                        <input type="number" id="sB_${m._id}" value="${m.teamB.score}" min="0" max="4">
                        <button onclick="settleMatch('${m._id}')" class="btn-primary" style="padding:4px 10px; font-size:0.8rem; margin-left:10px;">
                            ç¡®è®¤
                        </button>
                    `;
                }

                const lockBtn = (!isTBD && !isFin) ? `
                    <button onclick="toggleLock('${m._id}')" style="margin-left:15px; border:1px solid #ddd; background:${isLocked ? '#ffeba7' : 'white'}; padding:5px 10px; border-radius:5px; cursor:pointer;" title="${isLocked ? 'ç‚¹å‡»è§£é”' : 'ç‚¹å‡»é”å®š'}">
                        ${isLocked ? 'ğŸ”’ å·²é”' : 'ğŸ”“ å¼€æ”¾'}
                    </button>
                ` : '';

                container.innerHTML += `
                    <div class="${rowClass}">
                        <div class="match-info">
                            <span class="match-id">${m.customId}</span> 
                            <b>${teamA}</b> <span style="font-size:0.8em; color:#888;">vs</span> <b>${teamB}</b>
                            
                            <div style="margin-top:8px; display:flex; align-items:center; gap:5px;">
                                <input type="datetime-local" id="time_${m._id}" value="${localIso}" 
                                    style="font-size:0.75rem; padding:2px; width:140px; border:1px solid #ddd; color:#666;">
                                <button onclick="updateTime('${m._id}')" title="æ›´æ–°æ¯”èµ›æ—¶é—´"
                                    style="font-size:0.7rem; padding:2px 6px; background:#f0f0f0; border:1px solid #ccc; cursor:pointer; border-radius:3px;">
                                    ğŸ•’ æ›´æ–°
                                </button>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center;">
                            ${controlHtml}
                            ${lockBtn}
                        </div>
                    </div>`;
            });
        }

        async function updateTime(matchId) {
            const input = document.getElementById(`time_${matchId}`);
            const newTimeStr = input.value; // "2025-11-26T19:00"
            if (!newTimeStr) return alert("æ—¶é—´ä¸èƒ½ä¸ºç©º");
            
            const newDate = new Date(newTimeStr);
            const isoTime = newDate.toISOString(); // è½¬å› UTC

            if (!confirm(`âš ï¸ ç¡®è®¤ä¿®æ”¹æ¯”èµ›æ—¶é—´å—ï¼Ÿ\n\næ–°æ—¶é—´: ${newDate.toLocaleString()}\n\nä¿®æ”¹åï¼Œè‡ªåŠ¨é”å®š/è§£é”å°†ç«‹å³æ ¹æ®æ–°æ—¶é—´ç”Ÿæ•ˆã€‚`)) return;

            try {
                const res = await fetch(API + '/update-time', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ matchId: matchId, newStartTime: isoTime })
                });
                const data = await res.json();
                if (data.success) {
                    alert(data.message);
                    // loadMatches(); // å¯é€‰ï¼šåˆ·æ–°ä»¥ç¡®è®¤
                } else {
                    alert("é”™è¯¯: " + data.message);
                }
            } catch (e) { alert("ç½‘ç»œé”™è¯¯"); }
        }

        async function settleMatch(id) {
            const sA = document.getElementById(`sA_${id}`).value;
            const sB = document.getElementById(`sB_${id}`).value;
            
            if(!confirm(`âš ï¸ ç¡®è®¤å½•å…¥ç»“æœ ${sA} : ${sB} å—ï¼Ÿ\n\nè¿™å°†è§¦å‘ï¼š\n1. æ‰€æœ‰ç©å®¶åˆ¤åˆ†\n2. éšè—æˆå°±è‡ªåŠ¨ç»“ç®—\n3. èƒœè€…è‡ªåŠ¨æ™‹çº§`)) return;
            
            try {
                const res = await fetch(API + '/settle', { 
                    method:'POST', headers, 
                    body:JSON.stringify({ matchId:id, scoreA:sA, scoreB:sB }) 
                });
                const data = await res.json();
                if(data.success) {
                    alert(data.message + (data.achievements && data.achievements.length ? `\n\nğŸ† æœ¬åœºäº§ç”Ÿæ–°æˆå°±:\n${data.achievements.join('\n')}` : ''));
                    loadMatches();
                } else {
                    alert('âŒ é”™è¯¯: ' + data.message);
                }
            } catch(e) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        async function resetMatch(id) {
            if(!confirm('âš ï¸ é«˜å±æ“ä½œï¼šç¡®å®šè¦æ’¤é”€è¿™åœºæ¯”èµ›å—ï¼Ÿ\n\næ‰€æœ‰å› æ­¤åœºæ¯”èµ›è·å¾—çš„ç§¯åˆ†å°†è¢«æ‰£é™¤ï¼')) return;
            const res = await fetch(API + '/reset-match', { method:'POST', headers, body:JSON.stringify({matchId:id}) });
            alert((await res.json()).message);
            loadMatches();
        }

        // [æ–°å¢] åˆ‡æ¢é”å®šçŠ¶æ€
        async function toggleLock(id) {
            const res = await fetch(API + '/toggle-lock', { method:'POST', headers, body:JSON.stringify({matchId:id}) });
            const data = await res.json();
            if(data.success) {
                loadMatches();
            } else {
                alert(data.message);
            }
        }

        // [æ–°å¢] å·¥å‚é‡ç½®
        async function factoryReset() {
            const code = prompt("âš ï¸ é«˜å±æ“ä½œè­¦å‘Šï¼\n\nè¿™å°†æ¸…ç©ºæ‰€æœ‰ç©å®¶æ•°æ®å¹¶é‡ç½®èµ›ç¨‹ï¼\n\nè¯·è¾“å…¥ 'DELETE' (å…¨å¤§å†™) ç¡®è®¤æ“ä½œ:");
            if (code !== 'DELETE') {
                if (code !== null) alert("ç¡®è®¤ç é”™è¯¯");
                return;
            }

            const res = await fetch(API + '/factory-reset', { 
                method:'POST', headers, 
                body: JSON.stringify({ confirmation: code }) 
            });
            const data = await res.json();
            
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert("é”™è¯¯: " + data.message);
            }
        }

        // ============================
        // 2. ç©å®¶ç®¡ç†é€»è¾‘
        // ============================
        async function searchUsers() {
            const q = document.getElementById('user-search').value;
            const res = await fetch(API + `/search-users?q=${q}`, { headers });
            const users = await res.json();
            renderUsers(users);
        }

        function renderUsers(users) {
            const container = document.getElementById('user-results');
            if (users.length === 0) { container.innerHTML = '<p style="text-align:center; color:#888">æœªæ‰¾åˆ°ç›¸å…³ç©å®¶</p>'; return; }

            container.innerHTML = users.map(u => {
                let achHtml = u.achievements.map(a => `
                    <span class="ach-tag">
                        ${a.name}
                        <span class="ach-remove" onclick="manageAch('${u._id}', 'remove', '${a.name}')" title="ç§»é™¤æ­¤æˆå°±">Ã—</span>
                    </span>
                `).join('');
                if(achHtml === '') achHtml = '<span style="color:#999; font-size:0.8rem">æš‚æ— æˆå°±</span>';

                let options = ALL_ACHIEVEMENTS.map(name => `<option value="${name}">${name}</option>`).join('');

                return `
                <div class="user-row">
                    <div class="user-header">
                        <div>
                            <span style="font-size:1.1rem; font-weight:bold;">${u.nickname}</span>
                            <div class="user-stats">ğŸ† æ€»åˆ†: <b>${u.totalScore}</b></div>
                        </div>
                        <button onclick="openManual('${u._id}', '${u.nickname}')" style="background:#fff; border:1px solid #ccc; padding:5px 10px; cursor:pointer; border-radius:4px;">
                            âš¡ ä¿®æ­£åˆ†æ•°
                        </button>
                    </div>
                    
                    <div style="background:#f4f4f4; padding:8px; border-radius:6px;">
                        <div style="font-size:0.75rem; color:#888; margin-bottom:5px;">æˆå°±ç®¡ç† (æ·»åŠ +0.5åˆ† / ç§»é™¤-0.5åˆ†):</div>
                        <div class="user-achievements">
                            ${achHtml}
                            <div style="display:flex; align-items:center; margin-left:auto;">
                                <select id="ach-select-${u._id}" style="padding:3px; border-radius:4px; border:1px solid #ccc;">${options}</select>
                                <button onclick="addAch('${u._id}')" style="background:var(--accent-purple); color:white; border:none; padding:4px 8px; border-radius:4px; margin-left:5px; cursor:pointer;">
                                    + æ·»åŠ 
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function manageAch(userId, action, achName) {
            const verb = action === 'add' ? 'æˆäºˆ' : 'ç§»é™¤';
            if(!confirm(`ç¡®å®šè¦ä¸ºè¯¥ç©å®¶ ${verb} æˆå°± [${achName}] å—ï¼Ÿ\nåˆ†æ•°å°†è‡ªåŠ¨ ${action === 'add' ? '+0.5' : '-0.5'}ã€‚`)) return;

            const res = await fetch(API + '/manage-achievement', {
                method: 'POST', headers,
                body: JSON.stringify({ userId, action, achievementName: achName })
            });
            const data = await res.json();
            if (data.success) searchUsers(); 
            else alert(data.message);
        }

        function addAch(userId) {
            const achName = document.getElementById(`ach-select-${userId}`).value;
            manageAch(userId, 'add', achName);
        }

        // ============================
        // 3. æ‰‹åŠ¨ä¿®æ­£é€»è¾‘
        // ============================
        function openManual(id, name) {
            document.getElementById('manual-overlay').style.display = 'block';
            document.getElementById('manual-form').style.display = 'block';
            document.getElementById('target-user-name').innerText = name;
            document.getElementById('target-user-id').value = id;
            document.getElementById('manual-points').value = '';
            document.getElementById('manual-reason').value = '';
        }
        function closeManual() {
            document.getElementById('manual-overlay').style.display = 'none';
            document.getElementById('manual-form').style.display = 'none';
        }
        async function submitManualScore() {
            const id = document.getElementById('target-user-id').value;
            const pts = document.getElementById('manual-points').value;
            const reason = document.getElementById('manual-reason').value;
            const targetDay = document.getElementById('manual-target-day').value;
            
            if(!pts || !reason) return alert("è¯·å¡«å†™å®Œæ•´çš„åˆ†æ•°å’Œç†ç”±");

            const res = await fetch(API + '/manual-score', { 
                method:'POST', headers, 
                body: JSON.stringify({ userId:id, points:pts, reason:reason, targetDay:targetDay }) 
            });
            const data = await res.json();
            if(data.success) {
                alert('ä¿®æ­£æˆåŠŸ');
                closeManual();
                searchUsers();
            } else {
                alert('é”™è¯¯: ' + data.message);
            }
        }
    </script>
</body>
</html>