<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è£åˆ¤æ§åˆ¶å° - OWCS Admin</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* --- åŸºç¡€å¸ƒå±€ --- */
        body { background-color: #333; color: #333; }
        .admin-container { max-width: 1000px; margin: 2rem auto; padding: 25px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        h1 { text-align: center; color: var(--accent-purple); margin-bottom: 30px; }
        .section-box { border: 2px solid #eee; padding: 20px; border-radius: 10px; margin-bottom: 25px; background: #fff; }
        .section-title { margin-top: 0; color: var(--accent-purple); border-bottom: 2px solid var(--primary-pink); padding-bottom: 10px; margin-bottom: 20px; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        
        /* --- æ¯”èµ›åˆ—è¡¨ --- */
        .match-row { display: flex; justify-content: space-between; align-items: flex-start; padding: 15px 12px; border-bottom: 1px solid #eee; transition: background 0.2s; }
        .match-row:hover { background: #f9f9f9; }
        .match-info { width: 45%; position: relative; /* å…³é”®ï¼šä¸ºå¼¹çª—å®šä½ */ }
        .match-id { font-size: 0.85em; color: #888; margin-right: 10px; font-family: monospace; }
        .match-row.tbd { background-color: #f5f5f5; color: #999; opacity: 0.7; }
        .status-finished { color: green; font-weight: bold; background: #e8f5e9; padding: 2px 8px; border-radius: 4px; }
        
        /* --- [ä¿®æ”¹] ç»Ÿè®¡æ¡æ ·å¼ --- */
        .admin-stats-box {
            margin-top: 8px;
            padding: 5px 8px;
            background: #f8f8f8;
            border-radius: 6px;
            border: 1px solid #eee;
            font-size: 0.75rem;
            cursor: pointer; /* å˜æˆæ‰‹å‹ï¼Œæç¤ºå¯ç‚¹å‡» */
            transition: background 0.2s;
        }
        .admin-stats-box:hover { background: #f0f0f0; border-color: #ccc; }
        .admin-stats-text { display: flex; justify-content: space-between; margin-bottom: 4px; color: #555; }
        .admin-bar-bg { width: 100%; height: 6px; background: #ddd; border-radius: 3px; overflow: hidden; display: flex; }
        
        /* --- [ä¿®æ”¹] è¯¦ç»†åå•å¼¹çª— (Click to Show) --- */
        .stats-popup {
            display: none; /* é»˜è®¤éšè— */
            position: absolute;
            z-index: 1000;
            background-color: white;
            width: 240px;
            max-height: 300px;
            overflow-y: auto; /* å…è®¸æ»šåŠ¨ */
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            padding: 10px;
            top: 100%; /* æ˜¾ç¤ºåœ¨ä¸‹æ–¹ */
            left: 0;
            margin-top: 5px;
        }
        /* æ‰“å¼€çŠ¶æ€ */
        .stats-popup.active { display: block; }
        
        .tooltip-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 4px 0; 
            border-bottom: 1px dashed #eee; 
            font-size: 0.8rem;
        }
        .tooltip-item:last-child { border-bottom: none; }
        .tooltip-item b { color: var(--accent-purple); }

        /* --- ç”¨æˆ·ç®¡ç† & å¼¹çª— --- */
        .user-row { background: #fdfdfd; padding: 15px; margin-bottom: 10px; border-left: 5px solid var(--accent-purple); border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
        .user-stats { font-size: 0.9rem; color: #555; }
        .user-achievements { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
        .ach-tag { display: inline-flex; align-items: center; background: #e0d4fc; color: var(--accent-purple); padding: 4px 10px; border-radius: 15px; font-size: 0.85rem; font-weight: bold; }
        .ach-remove { cursor: pointer; color: #ff4d4d; margin-left: 6px; font-weight: bold; font-size: 1.1em; line-height: 1; }
        
        #manual-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999; backdrop-filter: blur(2px); }
        #manual-form { display:none; position: fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:25px; border-radius:15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1000; width: 320px; border: 2px solid var(--primary-pink); }
        #manual-form h4 { margin-top: 0; color: var(--accent-purple); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #manual-form label { display: block; margin-top: 10px; font-size: 0.85rem; font-weight: bold; color: #666; }
        #manual-form input, #manual-form select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 6px; }
        .form-actions { display:flex; gap:10px; margin-top:20px; }
        input[type="number"] { width: 40px; text-align: center; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="admin-container">
        <h1>ğŸ‘® OWCS èµ›äº‹æ€»æ§å°</h1>

        <div class="section-box">
            <h3 class="section-title">ğŸ‘¥ ç©å®¶ç®¡ç†</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="user-search" placeholder="è¾“å…¥æ˜µç§°..." style="flex:1; padding:10px; border:1px solid #ccc; border-radius:5px;">
                <button onclick="searchUsers()" class="btn-primary">ğŸ” æœç´¢</button>
            </div>
            <div id="user-results"></div>
        </div>

        <div class="section-box">
            <h3 class="section-title">ğŸ® æ¯”èµ›ç®¡ç†</h3>
            <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">
                * <b>ç‚¹å‡»ç»Ÿè®¡æ¡</b> å¯å±•å¼€/æ”¶èµ·è¯¦ç»†é¢„æµ‹åå•ã€‚<br>
                * å½•å…¥ç»“æœåè‡ªåŠ¨æ™‹çº§ã€‚
            </p>
            <div id="admin-matches"><div class="loading">åŠ è½½ä¸­...</div></div>
        </div>

        <div class="section-box" style="border-color:red; background:#fff5f5; margin-top:40px;">
            <h3 class="section-title" style="color:red; border-bottom-color:red;">â˜¢ï¸ å±é™©åŒºåŸŸ</h3>
            <button onclick="factoryReset()" style="background:red; color:white; border:none; padding:10px 20px; font-weight:bold; cursor:pointer; border-radius:5px; width:100%;">ğŸ’£ åˆ é™¤æ‰€æœ‰æ•°æ®å¹¶é‡ç½®ç³»ç»Ÿ</button>
        </div>
    </div>

    <div id="manual-overlay" onclick="closeManual()"></div>
    <div id="manual-form">
        <h4>âš¡ ä¿®æ­£åˆ†æ•°</h4><p style="margin:0 0 10px 0;font-size:0.9rem;">ç©å®¶:<b id="target-user-name"></b></p><input type="hidden" id="target-user-id">
        <label>ğŸ¯ åº”ç”¨èŒƒå›´:</label><select id="manual-target-day"><option value="0">ä»…æ€»åˆ†</option><option value="1">Day 1</option><option value="2">Day 2</option><option value="3">Day 3</option><option value="4">Day 4</option><option value="5">Day 5</option></select>
        <label>ğŸ”¢ åˆ†æ•°:</label><input type="number" id="manual-points" style="width:100%;text-align:left;">
        <label>ğŸ“ ç†ç”±:</label><input type="text" id="manual-reason">
        <div class="form-actions"><button onclick="submitManualScore()" class="btn-primary" style="flex:1">æäº¤</button><button onclick="closeManual()" style="flex:1;background:#eee;border:none;cursor:pointer;">å–æ¶ˆ</button></div>
    </div>

    <script>
        const API = '/api/admin';
        const headers = { 'Content-Type': 'application/json', 'adminSecret': '123456' };
        const ALL_ACHIEVEMENTS = ["é—ªç”µå¿µ", "è€å¼€çˆ±ç‚¸å¢™", "reverse sweep", "åƒåœŸè±†", "å†å†²ä¸€æ¬¡", "æœ€ä¸­å¹»æƒ³", "landonè§é¢äº¤é“ƒé“›tp", "å†¯å“¥è§é¢ä¸‰æ®µé—ª", "é—¹éº»äº†", "ä»¥çˆ¶ä¹‹å", "æ–°çš‡åè¡—", "åå‘æœ¨å­", "P>L", "è¥¿å·´å ¡", "å–œå¿§å‚åŠ", "æ¥æ™šäº†"];

        document.addEventListener('DOMContentLoaded', loadMatches);

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æ‰€æœ‰å¼¹çª—
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.admin-stats-box')) {
                document.querySelectorAll('.stats-popup').forEach(el => el.classList.remove('active'));
            }
        });

        async function loadMatches() {
            const [matchesRes, statsRes] = await Promise.all([ fetch('/api/matches'), fetch('/api/predict/stats') ]);
            const matches = await matchesRes.json();
            const stats = await statsRes.json(); 
            const container = document.getElementById('admin-matches');
            container.innerHTML = '';

            matches.forEach(m => {
                const isFin = m.status === 'finished';
                const isLocked = m.isExplicitlyLocked; 
                const tbdA = m.teamA.name === 'TBD', tbdB = m.teamB.name === 'TBD', isTBD = tbdA || tbdB;
                const teamA = tbdA ? m.teamA.displayName : m.teamA.name;
                const teamB = tbdB ? m.teamB.displayName : m.teamB.name;
                const d = new Date(m.startTime);
                const localIso = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);

                // ç»Ÿè®¡æ•°æ®
                const stat = stats[m._id] || { A: 0, B: 0, total: 0, list: [] };
                const total = stat.total;
                const pctA = total > 0 ? Math.round((stat.A / total) * 100) : 0;
                const pctB = total > 0 ? Math.round((stat.B / total) * 100) : 0;
                
                // [ä¿®æ”¹] å¼¹çª—å¼åˆ—è¡¨ (é»˜è®¤éšè—ï¼Œç‚¹å‡»æ˜¾ç¤º)
                let listHtml = '';
                if (stat.list && stat.list.length > 0) {
                    // æŒ‰é¢„æµ‹æ¯”åˆ†æ’åºä¼˜åŒ–é˜…è¯»
                    stat.list.sort((a,b) => a.score.localeCompare(b.score));
                    const listItems = stat.list.map(item => 
                        `<div class="tooltip-item"><span>${item.name}</span><b>${item.score}</b></div>`
                    ).join('');
                    listHtml = `<div class="stats-popup" id="popup-${m._id}">${listItems}</div>`;
                } else {
                    listHtml = `<div class="stats-popup" id="popup-${m._id}"><div style="color:#999;text-align:center;">æš‚æ— è®°å½•</div></div>`;
                }

                let statsHtml = '';
                if (total > 0) {
                    statsHtml = `
                        <div class="admin-stats-box" onclick="toggleStats('${m._id}')" title="ç‚¹å‡»å±•å¼€è¯¦æƒ…">
                            ${listHtml}
                            <div class="admin-stats-text">
                                <span style="color:var(--primary-pink)"><b>${stat.A}</b> ç¥¨ (${pctA}%)</span>
                                <span>å…± ${total} äºº â–¼</span>
                                <span style="color:var(--accent-purple)"><b>${stat.B}</b> ç¥¨ (${pctB}%)</span>
                            </div>
                            <div class="admin-bar-bg">
                                <div style="width:${pctA}%; background:var(--primary-pink);"></div>
                                <div style="width:${pctB}%; background:var(--accent-purple);"></div>
                            </div>
                        </div>
                    `;
                } else {
                    statsHtml = `<div class="admin-stats-box" style="color:#aaa; text-align:center; cursor:default;">(æš‚æ— é¢„æµ‹)</div>`;
                }

                // æ§ä»¶
                let controlHtml = isTBD ? `<span style="font-size:0.8rem; color:#aaa;">ğŸ”’ ç­‰å¾…æ™‹çº§</span>` :
                    (isFin ? `<span class="status-finished">âœ… ${m.teamA.score}:${m.teamB.score}</span> <button onclick="resetMatch('${m._id}')" style="margin-left:5px;border:none;background:none;cursor:pointer;">âŒ</button>` :
                    `<input type="number" id="sA_${m._id}" value="${m.teamA.score}" min="0" max="4">:<input type="number" id="sB_${m._id}" value="${m.teamB.score}" min="0" max="4"><button onclick="settleMatch('${m._id}')" class="btn-primary" style="padding:2px 8px;font-size:0.8rem;margin-left:5px;">ç¡®è®¤</button>`);
                
                const lockBtn = (!isTBD && !isFin) ? `<button onclick="toggleLock('${m._id}')" style="margin-left:15px; border:1px solid #ddd; background:${isLocked ? '#ffeba7' : 'white'}; padding:5px 10px; border-radius:5px; cursor:pointer;">${isLocked ? 'ğŸ”’' : 'ğŸ”“'}</button>` : '';

                container.innerHTML += `
                    <div class="${isTBD?'match-row tbd':'match-row'}">
                        <div class="match-info">
                            <span class="match-id">${m.customId}</span> <b>${teamA}</b> vs <b>${teamB}</b>
                            <div style="margin-top:8px; display:flex; align-items:center; gap:5px;">
                                <input type="datetime-local" id="time_${m._id}" value="${localIso}" style="font-size:0.75rem; padding:2px; width:135px; border:1px solid #ddd; color:#666;">
                                <button onclick="updateTime('${m._id}')" style="font-size:0.7rem; padding:2px 6px; background:#f0f0f0; border:1px solid #ccc; cursor:pointer;">ğŸ•’ æ›´æ–°</button>
                            </div>
                            ${statsHtml}
                        </div>
                        <div style="display:flex; align-items:center;">${controlHtml}${lockBtn}</div>
                    </div>`;
            });
        }

        // [æ–°å¢] åˆ‡æ¢å¼¹çª—æ˜¾ç¤º
        function toggleStats(matchId) {
            const popup = document.getElementById(`popup-${matchId}`);
            if(!popup) return;
            
            const isActive = popup.classList.contains('active');
            // å…ˆå…³é—­æ‰€æœ‰
            document.querySelectorAll('.stats-popup').forEach(el => el.classList.remove('active'));
            
            // å¦‚æœä¹‹å‰æ²¡æ‰“å¼€ï¼Œç°åœ¨æ‰“å¼€
            if (!isActive) popup.classList.add('active');
        }

        async function updateTime(matchId) {
            const input = document.getElementById(`time_${matchId}`);
            if (!input.value) return alert("æ—¶é—´ä¸èƒ½ä¸ºç©º");
            const isoTime = new Date(input.value).toISOString();
            if (!confirm(`ç¡®è®¤ä¿®æ”¹æ—¶é—´?`)) return;
            await fetch(API + '/update-time', { method: 'POST', headers, body: JSON.stringify({ matchId, newStartTime: isoTime }) });
            alert("æ—¶é—´å·²æ›´æ–°");
        }

        async function settleMatch(id) {
            const sA=document.getElementById(`sA_${id}`).value, sB=document.getElementById(`sB_${id}`).value;
            if(!confirm(`ç¡®è®¤ ${sA}:${sB}?`))return;
            await fetch(API+'/settle',{method:'POST',headers,body:JSON.stringify({matchId:id,scoreA:sA,scoreB:sB})}); loadMatches();
        }
        async function resetMatch(id){ if(confirm('æ’¤é”€?')) { await fetch(API+'/reset-match',{method:'POST',headers,body:JSON.stringify({matchId:id})}); loadMatches(); } }
        async function toggleLock(id){ const res=await fetch(API+'/toggle-lock',{method:'POST',headers,body:JSON.stringify({matchId:id})}); if((await res.json()).success) loadMatches(); }
        async function factoryReset(){ if(prompt("è¾“å…¥ DELETE ç¡®è®¤:")==='DELETE'){ await fetch(API+'/factory-reset',{method:'POST',headers,body:JSON.stringify({confirmation:'DELETE'})}); location.reload(); } }
        async function searchUsers(){ const q=document.getElementById('user-search').value; const res=await fetch(API+`/search-users?q=${q}`,{headers}); renderUsers(await res.json()); }
        function renderUsers(users){ 
            const c=document.getElementById('user-results'); c.innerHTML=users.map(u=>`
            <div class="user-row">
                <div class="user-header"><div><span style="font-size:1.1rem; font-weight:bold;">${u.nickname}</span> (${u.totalScore})</div><button onclick="openManual('${u._id}','${u.nickname}')">âš¡ ä¿®æ­£</button></div>
                <div style="background:#f4f4f4; padding:8px; border-radius:6px;">
                    <div class="user-achievements">
                        ${u.achievements.map(a => `<span class="ach-tag">${a.name}<span class="ach-remove" onclick="manageAch('${u._id}', 'remove', '${a.name}')">Ã—</span></span>`).join('') || '<span style="color:#999;font-size:0.8rem">æ— æˆå°±</span>'}
                        <div style="margin-left:auto; display:flex;">
                            <select id="ach-select-${u._id}">${ALL_ACHIEVEMENTS.map(n => `<option>${n}</option>`)}</select>
                            <button onclick="addAch('${u._id}')" style="margin-left:5px;">+</button>
                        </div>
                    </div>
                </div>
            </div>`).join(''); 
        }
        async function manageAch(uid,act,name){ if(confirm(act)) { await fetch(API+'/manage-achievement',{method:'POST',headers,body:JSON.stringify({userId:uid,action:act,achievementName:name})}); searchUsers(); } }
        function addAch(id) { manageAch(id, 'add', document.getElementById(`ach-select-${id}`).value); }
        function openManual(id,name){ document.getElementById('manual-overlay').style.display='block'; document.getElementById('manual-form').style.display='block'; document.getElementById('target-user-name').innerText=name; document.getElementById('target-user-id').value=id; }
        function closeManual(){ document.getElementById('manual-overlay').style.display='none'; document.getElementById('manual-form').style.display='none'; }
        async function submitManualScore(){ 
            const id=document.getElementById('target-user-id').value, pts=document.getElementById('manual-points').value, r=document.getElementById('manual-reason').value, d=document.getElementById('manual-target-day').value;
            await fetch(API+'/manual-score',{method:'POST',headers,body:JSON.stringify({userId:id,points:pts,reason:r,targetDay:d})}); closeManual(); searchUsers();
        }
    </script>
</body>
</html>